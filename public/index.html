<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WalSmart – Powered by VoxTalk™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="style.css">
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <header class="navbar">
    <h1 class="brand">
      <span class="brand-main">WalSmart</span>
      <span class="brand-icon">✳</span>
      <span class="powered-by">Powered by VoxTalk™</span>
    </h1>
  </header>

  <main class="container">
    <div class="portal-buttons">
      <button id="cartBtn" class="portal">Cart</button>
      <button id="infoBtn" class="portal">Info</button>
      <button id="checkoutBtn" class="portal">Checkout</button>
    </div>

    <div class="chat-section">
      <h2>Talk to VoxTalk</h2>
      <button id="pttBtn" aria-pressed="false" class="halo-button"></button>
      <div class="hint">Click to Talk</div>
      <div id="answer"><div class="muted">Conversation will appear here.</div></div>
      <audio id="remote" autoplay playsinline></audio>

      <div class="classic-chat">
        <input id="userInput" placeholder="Type here to chat…" />
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <div class="upload-section">
      <label for="fileUpload">Upload grocery list:</label>
      <input type="file" id="fileUpload" accept=".txt,.jpg,.png,.pdf">
    </div>

    <div class="purchase-section">
      <button id="checkout">Buy Now</button>
    </div>
  </main>

  <footer>
    <p>©2025 WalSmart – All Rights Reserved.</p>
  </footer>

  <script>
    const stripe = Stripe("<%= STRIPE_PUBLIC_KEY %>");
    const checkoutBtn = document.getElementById("checkout");

    checkoutBtn.addEventListener("click", async () => {
      const res = await fetch("/create-checkout-session", { method: "POST" });
      const data = await res.json();
      const result = await stripe.redirectToCheckout({ sessionId: data.id });
      if (result.error) alert(result.error.message);
    });

    // --- VoxTalk Realtime / Classic Chat ---
    const pttBtn   = document.getElementById("pttBtn");
    const answerEl = document.getElementById("answer");
    const remoteEl = document.getElementById("remote");
    const inputEl  = document.getElementById("userInput");
    const sendBtn  = document.getElementById("sendBtn");

    async function startSession() {
      const r = await fetch("/session");
      const data = await r.json();
      const pc = new RTCPeerConnection();
      const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
      ms.getTracks().forEach(t => pc.addTrack(t, ms));
      pc.ontrack = e => remoteEl.srcObject = e.streams[0];
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      const sdpResponse = await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${data.client_secret.value}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });
      const answer = { type: "answer", sdp: await sdpResponse.text() };
      await pc.setRemoteDescription(answer);
    }

    pttBtn.addEventListener("click", startSession);

    sendBtn.addEventListener("click", async () => {
      const text = inputEl.value.trim();
      if (!text) return;
      const r = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      const data = await r.json();
      answerEl.innerHTML = `<p>${data.reply}</p>`;
      inputEl.value = "";
    });
  </script>
</body>
</html>
