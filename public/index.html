<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Walmart âœ³ â€” VoxTalkâ„¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="navbar">
    <div class="brand-bar">
      <h1 class="brand">
        <span class="brand-main">Walmart</span>
        <span class="brand-icon" aria-label="spark">
          <!-- 6-ray Walmart spark -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="spark" role="img">
            <path fill="#fdb913" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(60 32 32)" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(120 32 32)" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(180 32 32)" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(240 32 32)" d="M31 0h2v22h-2z"/>
            <path fill="#fdb913" transform="rotate(300 32 32)" d="M31 0h2v22h-2z"/>
          </svg>
        </span>
      </h1>
    </div>
    <p class="tagline">
      <button id="taglineUpload" class="tagline-link">Upload your grocery list here</button>
    </p>
  </header>

  <main class="container">
    <div class="portal-row">
      <button class="portal" onclick="openModal('cartModal')">ğŸ›’ Cart</button>
      <button class="portal" onclick="openModal('infoModal')">â„¹ï¸ Info</button>
      <button class="portal" onclick="window.open('https://www.walmart.com/grocery','_blank')">ğŸ’³ Checkout</button>
    </div>

    <div class="stage">
      <button id="haloBtn" class="halo-btn">
        <div class="halo ring r1"></div>
        <div class="halo ring r2"></div>
        <div class="halo ring r3"></div>
        <span id="haloLabel" class="halo-label">Click to Talk</span>
      </button>
      <audio id="remote" autoplay playsinline></audio>
      <button id="stopBtn" class="stop-btn hidden">Pause Voice</button>
    </div>

    <section class="quiet">
      <form id="quietForm" class="quiet-form" autocomplete="off">
        <input id="quietInput" class="quiet-input"
               type="text" placeholder="Classic chat â€” for quiet environments" />
        <button id="micBtn" class="pill mic-btn" type="button">ğŸ¤</button>
        <button id="sendBtn" class="pill send-btn" type="submit">Send</button>
      </form>
      <div id="thread" class="thread"></div>
    </section>

    <button class="corner-btn left" onclick="window.print()">ğŸ–¨ Show Conversation</button>
    <a class="corner-btn right" href="tel:18885551234">ğŸ“ Contact Human</a>
  </main>

  <!-- CART -->
  <div id="cartModal" class="modal hidden">
    <div class="modal-content">
      <h2>Your Cart â€“ Walmartâ„¢</h2>
      <p>This opens Walmartâ€™s real cart page.</p>
      <button class="pill"
        onclick="window.open('https://www.walmart.com/cart','_blank')">Go to Cart</button>
      <button class="pill ghost" onclick="closeModal('cartModal')">Close</button>
    </div>
  </div>

  <!-- INFO -->
  <div id="infoModal" class="modal hidden">
    <div class="modal-content">
      <h2>About Walmart & VoxTalk</h2>
      <p><strong>VoxTalkâ„¢ AI</strong> helps customers shop confidently â€” voice or text.
      Visit <a href="https://www.walmart.com" target="_blank">Walmart.com</a>.</p>
      <button class="pill ghost" onclick="closeModal('infoModal')">Close</button>
    </div>
  </div>

  <footer class="footer">
    Â© 2025 â€¢ Powered by VoxTalk â€” A Comfortable AI Experience
  </footer>

  <script>
  // Upload
  const fileUpload=document.createElement("input");
  fileUpload.type="file";fileUpload.hidden=true;document.body.appendChild(fileUpload);
  document.getElementById("taglineUpload").onclick=()=>fileUpload.click();

  // Modal logic
  function openModal(id){document.getElementById(id).classList.remove("hidden");}
  function closeModal(id){document.getElementById(id).classList.add("hidden");}
  document.querySelectorAll(".modal").forEach(m=>{
    m.addEventListener("click",e=>{if(e.target===m)m.classList.add("hidden");});
  });

  // Voice mic / halo label
  const haloBtn=document.getElementById("haloBtn");
  const stopBtn=document.getElementById("stopBtn");
  const haloLabel=document.getElementById("haloLabel");
  const remote=document.getElementById("remote");
  let pc,localStream;

  haloBtn.onclick=async()=>{
    haloBtn.disabled=true;
    haloLabel.textContent="Connectingâ€¦";
    const resp=await fetch("/session",{method:"POST"});
    const data=await resp.json();
    if(!data?.client_secret?.value){haloLabel.textContent="Error";return;}
    pc=new RTCPeerConnection();
    pc.ontrack=e=>remote.srcObject=e.streams[0];
    localStream=await navigator.mediaDevices.getUserMedia({audio:true});
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    const offer=await pc.createOffer();await pc.setLocalDescription(offer);
    const r2=await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview",{
      method:"POST",
      headers:{
        Authorization:`Bearer ${data.client_secret.value}`,
        "Content-Type":"application/sdp"
      },
      body:offer.sdp
    });
    const answer={type:"answer",sdp:await r2.text()};
    await pc.setRemoteDescription(answer);
    haloLabel.textContent="Live";
    stopBtn.classList.remove("hidden");
  };

  stopBtn.onclick=()=>{
    if(localStream)localStream.getTracks().forEach(t=>t.stop());
    if(pc)pc.close();
    haloBtn.disabled=false;
    haloLabel.textContent="Click to Talk";
    stopBtn.classList.add("hidden");
  };

  // Classic chat
  const form=document.getElementById("quietForm");
  const input=document.getElementById("quietInput");
  const thread=document.getElementById("thread");
  form.onsubmit=async(e)=>{
    e.preventDefault();
    const text=input.value.trim(); if(!text)return;
    const userDiv=document.createElement("div");
    userDiv.textContent="ğŸ§ "+text; thread.appendChild(userDiv); input.value="";
    const resp=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:text})});
    const data=await resp.json();
    const botDiv=document.createElement("div");
    botDiv.textContent="ğŸ¤– "+(data.reply||"..."); thread.appendChild(botDiv);
    thread.scrollTop=thread.scrollHeight;
  };

  // Mic inside chat (speech-to-text)
  const micBtn=document.getElementById("micBtn");
  if('webkitSpeechRecognition' in window){
    const recog=new webkitSpeechRecognition();
    recog.lang='en-US';
    recog.onresult=e=>{input.value=e.results[0][0].transcript;};
    micBtn.onclick=()=>{
      recog.start();
      micBtn.textContent='ğŸ™ï¸';
      setTimeout(()=>micBtn.textContent='ğŸ¤',2000);
    };
  } else {micBtn.disabled=true;}
  </script>
</body>
</html>
