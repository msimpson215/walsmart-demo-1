<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Walmart ‚Äì AI experience ‚Ä¢ VoxTalk‚Ñ¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="navbar">
    <h1 class="brand">
      Walmart<span class="brand-icon">‚ú≥</span>
    </h1>
    <p class="ai-powered">AI experience ‚Äî powered by VoxTalk‚Ñ¢</p>
  </header>

  <main class="container">
    <div class="portal-row">
      <button id="cartBtn" class="portal">üõí Cart</button>
      <button id="infoBtn" class="portal">‚ÑπÔ∏è Info</button>
      <button id="checkoutBtn" class="portal">üí≥ Checkout</button>
    </div>

    <div class="upload-section">
      <button id="uploadBtn">Upload your grocery list</button>
      <input type="file" id="fileUpload" accept=".txt,.jpg,.png,.pdf" hidden>
    </div>

    <div class="chat-section">
      <h2>Talk to your AI Walmart grocery associate</h2>
      <button id="pttBtn" class="halo-button"></button>
      <audio id="remote" autoplay playsinline></audio>

      <div id="answer" class="transcript"></div>

      <div class="classic-chat">
        <input id="userInput" placeholder="Type here to chat‚Ä¶" />
        <button id="sendBtn">Send</button>
      </div>

      <div class="controls">
        <button id="showConversation">Show Conversation</button>
        <button id="contactHuman">Contact a Human</button>
        <button id="stopBtn">Stop</button>
      </div>
    </div>

    <section id="cartPanel" class="panel hidden">
      <h3>Your Cart</h3><p>Your cart is empty.</p>
    </section>
    <section id="infoPanel" class="panel hidden">
      <h3>Information</h3><p>This is the standard VoxTalk layout.</p>
    </section>
    <section id="checkoutPanel" class="panel hidden">
      <h3>Checkout</h3><p>Checkout flow coming soon.</p>
    </section>
  </main>

  <script>
    // ----- upload -----
    const uploadBtn = document.getElementById('uploadBtn');
    const fileUpload = document.getElementById('fileUpload');
    uploadBtn.onclick = ()=> fileUpload.click();

    // ----- panel toggles -----
    const panels = {
      cartBtn:"cartPanel",
      infoBtn:"infoPanel",
      checkoutBtn:"checkoutPanel"
    };
    Object.keys(panels).forEach(id=>{
      document.getElementById(id).onclick = ()=>{
        Object.values(panels).forEach(pid=>document.getElementById(pid).classList.add("hidden"));
        document.getElementById(panels[id]).classList.remove("hidden");
      };
    });

    // ----- show conversation / contact / stop -----
    document.getElementById("showConversation").onclick = ()=>window.print();
    document.getElementById("contactHuman").onclick = ()=>window.location.href="mailto:support@example.com";
    document.getElementById("stopBtn").onclick = ()=>{
      try {
        if (window.micStream) window.micStream.getTracks().forEach(t=>t.stop());
        if (window.pc) window.pc.close();
      }catch{}
    };

    // ----- classic chat -----
    const userInput=document.getElementById("userInput");
    const sendBtn=document.getElementById("sendBtn");
    const answer=document.getElementById("answer");
    function add(role,text){
      const p=document.createElement("p"); p.textContent=text; p.className=role;
      answer.appendChild(p); answer.scrollTop=answer.scrollHeight;
    }
    async function sendMsg(){
      const text=userInput.value.trim(); if(!text) return;
      add("user",text); userInput.value="";
      try{
        const r=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text})});
        const d=await r.json(); add("assistant",d.reply||"");
      }catch(e){ add("error","Chat unavailable"); }
    }
    sendBtn.onclick=sendMsg;
    userInput.onkeydown=(e)=>{if(e.key==="Enter")sendMsg();};

    // ----- realtime -----
    const pttBtn=document.getElementById("pttBtn");
    const remote=document.getElementById("remote");
    pttBtn.onclick = async ()=>{
      try{
        const r=await fetch("/session");
        const data=await r.json();
        window.pc=new RTCPeerConnection();
        window.micStream=await navigator.mediaDevices.getUserMedia({audio:true});
        micStream.getTracks().forEach(t=>pc.addTrack(t,micStream));
        pc.ontrack=e=>remote.srcObject=e.streams[0];
        const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
        const sdp=await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview",
          {method:"POST",headers:{Authorization:`Bearer ${data.client_secret.value}`,"Content-Type":"application/sdp"},body:offer.sdp});
        const answer={type:"answer",sdp:await sdp.text()};
        await pc.setRemoteDescription(answer);
      }catch(e){add("error","Voice unavailable");}
    };
  </script>
</body>
</html>
