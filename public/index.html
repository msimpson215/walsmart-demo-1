<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WalSmart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Header -->
  <header class="topbar">
    <h1 class="brand">
      WalSmart<span class="spark">âœ³</span>
      <span class="powered">powered by VoxTalkâ„¢</span>
    </h1>
    <nav class="nav-buttons">
      <button class="pill ghost" onclick="openModal('cartModal')">Cart</button>
      <button class="pill ghost" onclick="openModal('infoModal')">Info</button>
      <button class="pill ghost" onclick="openModal('checkoutModal')">Checkout</button>
    </nav>
    <div class="upload-zone">
      <label for="listUpload" class="pill ghost">Upload Your Grocery List</label>
      <input id="listUpload" type="file" accept=".txt,.csv,.jpg,.jpeg,.png" hidden />
    </div>
  </header>

  <!-- Halo -->
  <main class="stage">
    <button id="haloBtn" class="halo-btn">
      <div class="halo ring r1"></div>
      <div class="halo ring r2"></div>
      <div class="halo ring r3"></div>
      <span class="halo-label">Click to Talk</span>
    </button>
    <audio id="remote" autoplay playsinline></audio>
    <button id="stopBtn" class="stop-btn hidden">Stop</button>
  </main>

  <!-- Classic Chat -->
  <section class="quiet">
    <form id="quietForm" class="quiet-form" autocomplete="off">
      <input id="quietInput" class="quiet-input" type="text"
        placeholder="Classic Chat â€” type your question here..." />
      <button id="sendBtn" class="pill send-btn" type="submit">Send</button>
    </form>
    <div id="thread" class="thread"></div>
  </section>

  <!-- Corner Buttons -->
  <button id="printBtn" class="corner-btn left" onclick="window.print()">Print Conversation</button>
  <a id="humanBtn" class="corner-btn right" href="tel:18005551234">Contact Human</a>

  <!-- Modals -->
  <div id="cartModal" class="modal hidden">
    <div class="modal-content">
      <h2>Your Cart</h2>
      <table class="cart-table">
        <tr><td>Organic Apples (2 lb)</td><td>$3.49</td></tr>
        <tr><td>Windshield De-Icer â€“ 1 gal</td><td>$12.99</td></tr>
        <tr><td><strong>Total</strong></td><td><strong>$16.48</strong></td></tr>
      </table>
      <p class="note">Click Checkout to proceed or Close to continue shopping.</p>
      <button class="pill" onclick="closeModal('cartModal')">Close</button>
    </div>
  </div>

  <div id="checkoutModal" class="modal hidden">
    <div class="modal-content">
      <h2>WalSmart Checkout</h2>
      <form class="checkout-form">
        <label>Name on Card</label><input type="text" placeholder="John Doe">
        <label>Card Number</label><input type="text" placeholder="â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 1234">
        <label>Expiration</label><input type="text" placeholder="MM/YY">
        <label>CVV</label><input type="text" placeholder="123">
        <label>Billing ZIP</label><input type="text" placeholder="63101">
        <button class="pill" type="button">Place Order</button>
      </form>
      <p class="note">Demo only â€” no real data sent.</p>
      <button class="pill" onclick="closeModal('checkoutModal')">Close</button>
    </div>
  </div>

  <div id="infoModal" class="modal hidden">
    <div class="modal-content">
      <h2>About WalSmart</h2>
      <p>
        Built on VoxTalkâ„¢ â€” a conversational assistant for real-time product help.
        Speak or type to find what you need and check out faster.
      </p>
      <p class="note">Click outside this box to return.</p>
      <button class="pill" onclick="closeModal('infoModal')">Close</button>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Modal logic
    function openModal(id){document.getElementById(id).classList.remove('hidden');}
    function closeModal(id){document.getElementById(id).classList.add('hidden');}
    document.querySelectorAll('.modal').forEach(m =>
      m.addEventListener('click', e => { if(e.target===m) m.classList.add('hidden'); })
    );

    // Grocery list upload
    document.getElementById('listUpload').addEventListener('change', e=>{
      const file=e.target.files[0];
      if(file) alert("Uploaded: "+file.name);
    });

    // Classic Chat
    const form=document.getElementById("quietForm");
    const input=document.getElementById("quietInput");
    const thread=document.getElementById("thread");
    form.onsubmit=async e=>{
      e.preventDefault();
      const text=input.value.trim();
      if(!text)return;
      const userDiv=document.createElement("div");
      userDiv.textContent="ðŸ§ "+text;
      thread.appendChild(userDiv);
      input.value="";
      const resp=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:text})});
      const data=await resp.json();
      const botDiv=document.createElement("div");
      botDiv.textContent="ðŸ¤– "+(data.reply||"...");
      thread.appendChild(botDiv);
      thread.scrollTop=thread.scrollHeight;
    };

    // Voice session
    const haloBtn=document.getElementById("haloBtn");
    const stopBtn=document.getElementById("stopBtn");
    const remote=document.getElementById("remote");
    let pc,localStream;
    haloBtn.onclick=async()=>{
      haloBtn.disabled=true;
      haloBtn.querySelector(".halo-label").textContent="Connecting...";
      try{
        const r=await fetch("/session",{method:"POST"});
        const d=await r.json();
        if(!d?.client_secret?.value)throw new Error("No secret");
        pc=new RTCPeerConnection();
        pc.ontrack=e=>remote.srcObject=e.streams[0];
        localStream=await navigator.mediaDevices.getUserMedia({audio:true});
        localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
        const offer=await pc.createOffer();
        await pc.setLocalDescription(offer);
        const r2=await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview",{
          method:"POST",
          headers:{
            Authorization:`Bearer ${d.client_secret.value}`,
            "Content-Type":"application/sdp"
          },
          body:offer.sdp
        });
        const answer={type:"answer",sdp:await r2.text()};
        await pc.setRemoteDescription(answer);
        haloBtn.querySelector(".halo-label").textContent="Live";
        stopBtn.classList.remove("hidden");
      }catch(e){
        haloBtn.querySelector(".halo-label").textContent="Error";
      }
    };
    stopBtn.onclick=()=>{
      if(localStream)localStream.getTracks().forEach(t=>t.stop());
      if(pc)pc.close();
      haloBtn.disabled=false;
      haloBtn.querySelector(".halo-label").textContent="Click to Talk";
      stopBtn.classList.add("hidden");
    };
  </script>
</body>
</html>
